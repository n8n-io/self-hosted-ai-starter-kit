FROM ubuntu:24.04

# 1) Install Intel CPU‑side oneAPI libs
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    intel-oneapi-mkl \        # Optimised math libs for CPU
    intel-oneapi-tbb \        # Threading runtime
    intel-oneapi-openmp \     # OpenMP runtime
    intel-oneapi-dnnl         # oneDNN for CPU inference

# 2) Add pinned Intel GPU runtime .debs BEFORE any other GPU packages
COPY intel-igc-core-2_2.14.1+19448_amd64.deb \
     intel-igc-opencl-2_2.14.1+19448_amd64.deb \
     libze-intel-gpu1_25.27.34303.5-0_amd64.deb /tmp/
RUN dpkg -i /tmp/intel-igc-core-2_2.14.1+19448_amd64.deb \
          /tmp/intel-igc-opencl-2_2.14.1+19448_amd64.deb \
          /tmp/libze-intel-gpu1_25.27.34303.5-0_amd64.deb \
 && apt-mark hold intel-igc-core intel-igc-opencl libze-intel-gpu1 \
 # Remove unwanted media/render stacks
 && apt-get purge -y --auto-remove \
      i965-va-driver va-driver-all mesa-va-drivers \
      intel-media-va-driver-non-free libmfx1 libmfxgen1 libvpl2 \
      mesa-utils libegl1-mesa libgl1-mesa-dri vainfo \
      intel-oneapi-runtime-compilers intel-oneapi-runtime-dpcpp \
 && rm -rf /var/lib/apt/lists/* /tmp/*.deb

# 3) Headless EGL + Level Zero environment defaults
ENV EGL_PLATFORM=surfaceless \
    LIBVA_DRIVER_NAME=iHD \
    OLLAMA_INTEL_GPU=true \
    ONEAPI_DEVICE_SELECTOR=level_zero:0

# 4) Load oneAPI environment variables
RUN echo 'source /opt/intel/oneapi/setvars.sh' >> /etc/profile.d/oneapi.sh

# 5) Install IPEX‑LLM Portable Ollama Build
ENV OLLAMA_DIR=/usr/local/lib/ollama \
    OLLAMA_BIN=/usr/local/bin/ollama

RUN curl -L -o /tmp/ollama.tgz https://github.com/ipex-llm/ipex-llm/releases/download/v2.2.0/ollama-ipex-llm-2.2.0-ubuntu.tgz \
 && mkdir -p ${OLLAMA_DIR} \
 && tar zxvf /tmp/ollama.tgz -C ${OLLAMA_DIR} \
 && ln -sf ${OLLAMA_DIR}/ollama ${OLLAMA_BIN} \
 && rm /tmp/ollama.tgz

# 6) Quick driver sanity‑check at build
RUN if dpkg -l | grep -E "i965-va-driver|va-driver-all|mesa-va-drivers"; then \
 echo "❌ Blocklisted drivers found!" && exit 1; \
 else \
 echo "✅ No banned VAAPI drivers detected."; \
 fi

# 7) Lightweight healthcheck — will run at container start
HEALTHCHECK --interval=30s --timeout=10s \
 CMD sycl-ls || exit 1

EXPOSE 11434

CMD ["ollama"]
