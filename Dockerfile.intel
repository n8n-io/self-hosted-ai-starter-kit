FROM ubuntu:24.04

# 1) Install only what you need, drop apt lists
RUN apt-get update \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      curl \
      mesa-utils \
      libegl1-mesa \
      libgl1-mesa-dri \
      intel-media-va-driver \
      vainfo \
 && rm -rf /var/lib/apt/lists/*

# 2) Tell EGL to run headless
ENV EGL_PLATFORM=surfaceless

# 3) Install Ollama CLI from GitHub
ENV OLLAMA_DIR=/usr/local/lib/ollama \
    OLLAMA_BIN=/usr/local/bin/ollama

RUN export RELEASE=$(curl -fsSL https://api.github.com/repos/ollama/ollama/releases/latest \
                   | grep '"tag_name"' \
                   | awk -F '"' '{print $4}') \
 && curl -fsSL "https://github.com/ollama/ollama/releases/download/${RELEASE}/ollama-linux-amd64.tgz" \
      -o /tmp/ollama.tgz \
 && mkdir -p ${OLLAMA_DIR} \
 && tar xzf /tmp/ollama.tgz -C ${OLLAMA_DIR} \
 && ln -sf ${OLLAMA_DIR}/bin/ollama ${OLLAMA_BIN} \
 && rm /tmp/ollama.tgz

EXPOSE 11434
CMD ["ollama"]
