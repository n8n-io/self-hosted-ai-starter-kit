FROM ubuntu:24.04

# 1) Add Intel GPU repository keys and sources
RUN apt-get update && apt-get install -y curl gnupg lsb-release \
 && curl -fsSL https://repositories.intel.com/gpu/intel-graphics.key | gpg --dearmor -o /usr/share/keyrings/intel-graphics.gpg \
 && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/intel-graphics.gpg] https://repositories.intel.com/gpu/ubuntu noble unified" \
 > /etc/apt/sources.list.d/intel-gpu.list

# 2) Install Intel GPU runtime components
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
 intel-level-zero-gpu \
 intel-opencl-icd \
 intel-media-va-driver-non-free \
 libmfx1 libmfxgen1 libvpl2 \
 intel-oneapi-runtime-compilers \
 intel-oneapi-runtime-dpcpp \
 clinfo intel-gpu-tools \
 mesa-utils libegl1-mesa libgl1-mesa-dri vainfo \
 && apt-get remove --purge -y i965-va-driver va-driver-all mesa-va-drivers || true \
 && rm -rf /var/lib/apt/lists/*

# 3) Headless EGL + Intel environment defaults
ENV EGL_PLATFORM=surfaceless \
    LIBVA_DRIVER_NAME=iHD \
    OLLAMA_INTEL_GPU=true \
    ONEAPI_DEVICE_SELECTOR=level_zero:0

# 4) Load oneAPI environment variables
RUN echo 'source /opt/intel/oneapi/setvars.sh' >> /etc/profile.d/oneapi.sh

# 5) Install IPEX‑LLM Portable Ollama Build
ENV OLLAMA_DIR=/usr/local/lib/ollama \
    OLLAMA_BIN=/usr/local/bin/ollama

RUN curl -L -o /tmp/ollama.tgz https://github.com/ipex-llm/ipex-llm/releases/download/v2.2.0/ollama-ipex-llm-2.2.0-ubuntu.tgz \
 && mkdir -p ${OLLAMA_DIR} \
 && tar zxvf /tmp/ollama.tgz -C ${OLLAMA_DIR} \
 && ln -sf ${OLLAMA_DIR}/ollama ${OLLAMA_BIN} \
 && rm /tmp/ollama.tgz

# 6) Quick driver sanity‑check at build
RUN if dpkg -l | grep -E "i965-va-driver|va-driver-all|mesa-va-drivers"; then \
 echo "❌ Blocklisted drivers found!" && exit 1; \
 else \
 echo "✅ No banned VAAPI drivers detected."; \
 fi

# 7) Lightweight healthcheck — will run at container start
HEALTHCHECK --interval=30s --timeout=10s \
 CMD sycl-ls || exit 1

EXPOSE 11434

CMD ["ollama"]
