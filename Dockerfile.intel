FROM ubuntu:24.04

# 1) Add Intel GPU repository keys and sources
RUN apt-get update && apt-get install -y curl gnupg lsb-release \
 && curl -fsSL https://repositories.intel.com/gpu/intel-graphics.key | gpg --dearmor -o /usr/share/keyrings/intel-graphics.gpg \
 && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/intel-graphics.gpg] https://repositories.intel.com/gpu/ubuntu noble unified" \
 > /etc/apt/sources.list.d/intel-gpu.list

# 2) Install Intel GPU runtime components
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
 intel-oneapi-mkl \           # Optimized math routines (BLAS, LAPACK, FFT) for CPU fallback
 intel-oneapi-tbb \           # Threading runtime for parallel CPU processing
 intel-oneapi-openmp \        # High-performance OpenMP runtime
 intel-oneapi-dnnl \          # oneDNN deep neural network library for CPU inference \
 intel-level-zero-gpu \
 intel-opencl-icd \
 clinfo intel-gpu-tools
COPY intel-igc-core-2_2.14.1+19448_amd64.deb \
     intel-igc-opencl-2_2.14.1+19448_amd64.deb \
     libze-intel-gpu1_25.27.34303.5-0_amd64.deb /tmp/
RUN dpkg -i /tmp/intel-igc-core-2_2.14.1+19448_amd64.deb \
           /tmp/intel-igc-opencl-2_2.14.1+19448_amd64.deb \
           /tmp/libze-intel-gpu1_25.27.34303.5-0_amd64.deb \
 && apt-mark hold intel-igc-core intel-igc-opencl libze-intel-gpu1 \
 && apt-get remove --purge -y i965-va-driver va-driver-all mesa-va-drivers || true \
 && rm -rf /var/lib/apt/lists/*

# 3) Headless EGL + Intel environment defaults
ENV EGL_PLATFORM=surfaceless \
    LIBVA_DRIVER_NAME=iHD \
    OLLAMA_INTEL_GPU=true \
    ONEAPI_DEVICE_SELECTOR=level_zero:0

# 4) Load oneAPI environment variables
RUN echo 'source /opt/intel/oneapi/setvars.sh' >> /etc/profile.d/oneapi.sh

# 5) Install IPEX‑LLM Portable Ollama Build
ENV OLLAMA_DIR=/usr/local/lib/ollama \
    OLLAMA_BIN=/usr/local/bin/ollama

RUN curl -L -o /tmp/ollama.tgz https://github.com/ipex-llm/ipex-llm/releases/download/v2.2.0/ollama-ipex-llm-2.2.0-ubuntu.tgz \
 && mkdir -p ${OLLAMA_DIR} \
 && tar zxvf /tmp/ollama.tgz -C ${OLLAMA_DIR} \
 && ln -sf ${OLLAMA_DIR}/ollama ${OLLAMA_BIN} \
 && rm /tmp/ollama.tgz

# 6) Quick driver sanity‑check at build
RUN if dpkg -l | grep -E "i965-va-driver|va-driver-all|mesa-va-drivers"; then \
 echo "❌ Blocklisted drivers found!" && exit 1; \
 else \
 echo "✅ No banned VAAPI drivers detected."; \
 fi

# 7) Lightweight healthcheck — will run at container start
HEALTHCHECK --interval=30s --timeout=10s \
 CMD sycl-ls || exit 1

EXPOSE 11434

CMD ["ollama"]
